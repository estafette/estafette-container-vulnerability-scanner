package main

import (
	"context"
	"encoding/json"
	"os"
	"strings"

	foundation "github.com/estafette/estafette-foundation"
)

type Scanner interface {
	ScanImage(image string) (vulnerabilityReports []VulnerabilityReport, err error)
	UpdateDatabase() (err error)
}

// NewScanner returns a new Scanner
func NewScanner(ctx context.Context) Scanner {
	return &scanner{
		ctx: ctx,
	}
}

type scanner struct {
	ctx context.Context
}

func (s *scanner) ScanImage(image string) (vulnerabilityReports []VulnerabilityReport, err error) {

	_, trivyFullDb := os.LookupEnv("TRIVY_FULL_DB")

	args := []string{"--quiet", "image", "--skip-update", "--no-progress", "--exit-code", "15", "--ignore-unfixed", "--format", "json"}

	if !trivyFullDb {
		args = append(args, "--light")
	}

	args = append(args, image)

	output, trivyErr := foundation.GetCommandWithArgsOutput(s.ctx, "/trivy", args)

	if trivyErr == nil {
		return
	}

	if strings.EqualFold(trivyErr.Error(), "exit status 1") {
		// ignore exit code, until trivy fixes this on their side, see https://github.com/aquasecurity/trivy/issues/8
	} else if strings.EqualFold(trivyErr.Error(), "exit status 15") {
		err = json.Unmarshal([]byte(output), &vulnerabilityReports)
	} else {
		err = trivyErr
	}

	return
}

func (s *scanner) UpdateDatabase() (err error) {

	_, trivyFullDb := os.LookupEnv("TRIVY_FULL_DB")

	args := []string{"--quiet", "image", "--download-db-only", "--no-progress"}

	if !trivyFullDb {
		args = append(args, "--light")
	}

	err = foundation.RunCommandWithArgsExtended(s.ctx, "/trivy", args)

	return
}

type VulnerabilityReport struct {
	Target          string
	Vulnerabilities []Vulnerability
}

type Vulnerability struct {
	VulnerabilityID  string
	PkgName          string
	InstalledVersion string
	FixedVersion     string
	Severity         string
}
