FROM alpine as gettrivy

ARG TRIVY_VERSION=0.18.3

SHELL ["/bin/ash", "-eo", "pipefail", "-c"]
RUN wget --quiet --output-document - https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | \
    tar -xzf - -C / \
    && /trivy --version \
    && /trivy --cache-dir /trivy-cache image --light --no-progress --download-db-only \
    && /trivy --cache-dir /trivy-cache image --severity CRITICAL --light --skip-update --no-progress --ignore-unfixed alpine:3.13


FROM golang:1.16-alpine as gobuilder

ARG CGO_ENABLED=0
ARG GOOS=linux
WORKDIR /go/src
COPY *go* ./
RUN go test ./... \
&&  go build -a -installsuffix cgo -o /estafette-vulnerability-scanner .

FROM scratch

LABEL maintainer="estafette.io" \
      description="The estafette-vulnerability-scanner regularly scans all containers in a Kubernetes cluster for vulnerabilities"

COPY --from=gettrivy /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=gettrivy /trivy /trivy
COPY --from=gobuilder /estafette-vulnerability-scanner /

ENTRYPOINT ["/estafette-vulnerability-scanner"]
