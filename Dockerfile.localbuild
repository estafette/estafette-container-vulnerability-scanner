ARG TRIVY_VERSION=0.22.0
FROM aquasec/trivy:${TRIVY_VERSION} as gettrivy

########################################################################
# hadolint ignore=DL3006
FROM alpine as getcerts

# hadolint ignore=DL3018
RUN apk add --no-cache ca-certificates

########################################################################

FROM golang:1.16-alpine as gobuilder

ARG CGO_ENABLED=0
ARG GOOS=linux

WORKDIR /go/src

COPY go.mod ./
COPY go.sum ./
RUN go mod download

COPY *.go ./
RUN go test ./...
# hadolint ignore=DL3059
RUN go build -a -installsuffix cgo -o /estafette-vulnerability-scanner .

########################################################################

FROM scratch

LABEL maintainer="estafette.io" \
      description="The estafette-vulnerability-scanner regularly scans all containers in a Kubernetes cluster for vulnerabilities"

COPY --from=getcerts /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=gettrivy /usr/local/bin/trivy /trivy
COPY --from=gobuilder /estafette-vulnerability-scanner /

ENTRYPOINT ["/estafette-vulnerability-scanner"]
